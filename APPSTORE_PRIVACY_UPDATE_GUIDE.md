# App Store Connect プライバシー設定更新ガイド

## 概要

このガイドでは、App Store Connect でアプリのプライバシー情報を更新し、非パーソナライズ広告のみを使用する設定に変更する手順を説明します。

## 変更内容の概要

### 変更前（Build 3）

- **NSPrivacyTracking**: `true`
- **NSPrivacyTrackingDomains**: Google AdMob ドメイン含む
- **問題**: ATT（App Tracking Transparency）未実装のため審査リジェクト

### 変更後（Build 4）

- **NSPrivacyTracking**: `false`
- **NSPrivacyTrackingDomains**: 削除
- **広告**: 非パーソナライズ広告のみ
- **結果**: ATT実装不要、プライバシー重視

## 手順

### ステップ1: App Store Connect にログイン

1. https://appstoreconnect.apple.com/ にアクセス
2. Apple ID でログイン
3. 「マイApp」をクリック
4. 「ココキタ」を選択

### ステップ2: App プライバシーセクションに移動

1. 左サイドバーから **「App プライバシー」** をクリック
2. 現在の設定を確認

### ステップ3: データの種類を確認・更新

#### 3-1. 収集するデータの確認

現在設定されているはずのデータ：
- **位置情報** (Precise Location)
  - リンク: なし
  - トラッキング: **なし** ← 確認
  - 目的: App機能
- **写真またはビデオ**
  - リンク: なし
  - トラッキング: **なし** ← 確認
  - 目的: App機能

#### 3-2. トラッキングに関する設定を更新

**重要**: 以下の項目を確認・変更

##### A. Advertising Data（広告データ）

**変更前**:
- 収集している: ✅
- トラッキングに使用: ✅
- 目的: 広告またはマーケティング

**変更後**:
1. 「Advertising Data」が存在する場合:
   - **トラッキングに使用**: ❌ **チェックを外す**
   - または項目自体を削除
2. 「Advertising Data」が存在しない場合:
   - 何もしない（追加不要）

##### B. Device ID（デバイスID）

**変更前**:
- 収集している: ✅
- トラッキングに使用: ✅
- 目的: 広告またはマーケティング

**変更後**:
1. 「Device ID」が存在する場合:
   - **トラッキングに使用**: ❌ **チェックを外す**
   - または項目自体を削除
2. 「Device ID」が存在しない場合:
   - 何もしない（追加不要）

### ステップ4: トラッキングステータスを確認

1. **「データの使用」** タブをクリック
2. **「このAppはあなたをトラッキングしますか？」** という質問を確認
3. **「いいえ」** を選択 ← 重要

### ステップ5: プライバシーポリシーURLを確認

1. プライバシーポリシーURLが設定されていることを確認
2. 設定されていない場合は追加:
   ```
   https://github.com/yourusername/kokokita/blob/main/PRIVACY_POLICY.md
   ```
   または独自のWebサイトURL

### ステップ6: 変更を保存

1. すべての変更を確認
2. 「保存」ボタンをクリック
3. 確認ダイアログで「保存」を再度クリック

### ステップ7: 新しいビルドを提出

#### 7-1. ビルド番号をインクリメント

Xcode で：
1. プロジェクト設定を開く
2. **TARGETS** → **kokokita** を選択
3. **General** タブ
4. **Identity** セクション
   - **Version**: `1.0.0` のまま（変更不要）
   - **Build**: `3` → `4` に変更

#### 7-2. Archive と Upload

```bash
# Xcodeで
1. Product → Archive
2. Archives ウィンドウで最新のアーカイブを選択
3. "Distribute App" をクリック
4. "App Store Connect" を選択
5. "Upload" を選択
6. 証明書とプロビジョニングプロファイルを確認
7. "Upload" をクリック
```

#### 7-3. App Store Connect でビルドを選択

1. App Store Connect に戻る
2. 「ココキタ」→ **「バージョン 1.0」** を選択
3. **「ビルド」** セクションで「+」をクリック
4. **Build 4** を選択
5. 「完了」をクリック

### ステップ8: Resolution Center で返信

1. App Store Connect の **「App Store」** タブ
2. 左サイドバーから **「Resolution Center」** をクリック
3. 最新のメッセージスレッドを開く
4. 以下のメッセージを送信:

---

**返信メッセージのテンプレート**:

```
ご確認いただきありがとうございます。

以下の対応を実施いたしました：

## 1. プライバシー設定の変更（Build 4）

非パーソナライズ広告のみを使用するよう変更いたしました：
- NSPrivacyTracking を false に設定
- NSPrivacyTrackingDomains を削除
- AdMob リクエストに非パーソナライズ設定を追加

これにより、App Tracking Transparency（ATT）の実装は不要となります。

## 2. App プライバシー情報の更新

App Store Connect のプライバシー設定を更新し、
「このAppはあなたをトラッキングしますか？」を「いいえ」に設定しました。

## 3. デモビデオの提供

物理デバイス（iPhone）でアプリが動作している様子を撮影したデモビデオを
App Review 情報セクションに追加いたしました：

[ビデオURL]

このビデオには以下の内容が含まれています：
- 位置情報許可リクエスト
- 「ココキタ」ボタンをタップして位置情報を記録する一連の流れ
- データ保存と地図表示の確認

## 4. 位置情報偽装検出について

本アプリはセキュリティのため、位置情報の偽装を検出する機能を実装しています。
リリースビルドでは以下の環境では動作しません：
- シミュレータ
- 位置情報がシミュレートされている実デバイス
- 開発者ツールにより位置情報が変更されている環境

これは意図的な設計であり、実際のユーザー環境（実位置情報を使用）では
正常に動作いたします。

Build 4 を提出いたしましたので、ご確認のほどよろしくお願いいたします。

ご不明な点がございましたら、お知らせください。
```

---

### ステップ9: 提出

1. **「審査に提出」** ボタンをクリック
2. 輸出コンプライアンスの質問に回答:
   - 暗号化を使用していますか？ → **はい**（HTTPSを使用）
   - ECCN が必要ですか？ → **いいえ**（標準的な暗号化のみ）
3. 「提出」をクリック

## チェックリスト

提出前に以下を確認：

### コード変更（Build 4）

- [ ] `PrivacyInfo.xcprivacy` の `NSPrivacyTracking` を `false` に変更
- [ ] `PrivacyInfo.xcprivacy` から `NSPrivacyTrackingDomains` を削除
- [ ] `BannerAdView.swift` に非パーソナライズ広告設定を追加
- [ ] ビルド番号を 4 にインクリメント
- [ ] Archive と Upload を実行

### App Store Connect 設定

- [ ] App プライバシーセクションで「トラッキング」を「いいえ」に設定
- [ ] Advertising Data のトラッキングチェックを外す（または削除）
- [ ] Device ID のトラッキングチェックを外す（または削除）
- [ ] 位置情報と写真のトラッキングが「なし」であることを確認
- [ ] Build 4 を選択
- [ ] デモビデオURLを App Review 情報に追加
- [ ] Resolution Center で返信
- [ ] 審査に提出

### デモビデオ

- [ ] 物理デバイスで撮影
- [ ] 位置情報許可ダイアログが含まれている
- [ ] 「ココキタ」機能の動作が明確
- [ ] YouTube/Dropbox にアップロード済み
- [ ] URL を App Review 情報に記載

## トラブルシューティング

### Q: Build 4 が App Store Connect に表示されない

**A**: 処理に時間がかかっている可能性があります。
- 通常、Upload 後 15〜60分で表示される
- 1時間以上経過しても表示されない場合は、Xcode の Organizer で Upload ステータスを確認

### Q: プライバシー設定を変更できない

**A**: Account Holder または Admin ロールが必要です。
- App Store Connect のユーザー権限を確認
- 必要に応じて Account Holder に依頼

### Q: デモビデオのURLをどこに記載すればよいか

**A**: App Review 情報セクションに記載します。
1. App Store Connect → ココキタ → バージョン 1.0
2. 左サイドバー「App 情報」
3. 下にスクロールして「App Review 情報」
4. 「メモ」フィールドに URL を記載

### Q: Resolution Center で返信できない

**A**: メッセージスレッドを開いて返信ボタンをクリックします。
1. App Store Connect → Resolution Center
2. 最新のメッセージを開く
3. 「返信」ボタンをクリック
4. メッセージを入力して送信

## まとめ

この変更により：
- ✅ ATT実装不要（非パーソナライズ広告のみ使用）
- ✅ プライバシー重視のアプリとしてアピール
- ✅ 審査要件を満たす
- ✅ 広告収益も維持（非パーソナライズ広告）

Build 4 の提出とプライバシー設定の更新により、審査をクリアできる見込みです。
